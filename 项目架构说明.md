# 梦境分析系统 - 项目架构说明

## 📁 项目结构总览

```
梦境/
├── api/                    # 后端API服务层
│   └── main.py            # FastAPI服务（唯一文件）
│
├── analyse_script/         # 核心分析算法层
│   ├── dream_analyzer.py  # 梦境分析核心类
│   ├── __init__.py        # Python包初始化
│   └── requirements_cpu.txt # Python依赖
│
├── dream_weaver/           # 前端界面层
│   ├── src/
│   │   ├── App.vue        # 主组件（核心）
│   │   ├── main.js        # Vue入口
│   │   ├── style.css      # 全局样式
│   │   ├── history.vue    # 历史记录组件
│   │   └── components/
│   │       └── HelloWorld.vue # 示例组件
│   ├── index.html         # HTML入口
│   ├── package.json       # 依赖管理
│   └── vite.config.js     # 构建配置
│
├── BLIP/                   # BLIP模型库（第三方，可删除）
│
├── scripts/                # 工具和测试脚本
│   └── test_image_generation.py # 图像生成测试
│
└── docs/                   # 项目文档
```

---

## 📂 详细目录说明

### 1️⃣ `api/` - 后端API服务层

**作用**: 提供HTTP RESTful API接口，接收前端请求并返回分析结果

#### 📄 `api/main.py`
- **功能**: FastAPI后端服务主文件（唯一文件）
- **职责**:
  - 接收前端HTTP请求（POST）
  - 调用 `analyse_script/dream_analyzer.py` 进行梦境分析
  - 处理图像上传和临时文件管理
  - 调用DashScope API生成梦境图像（集成在main.py中）
  - 返回JSON格式的分析结果

- **主要接口**:
  - `POST /analyze` - 梦境分析接口（文本+可选图片）
  - `POST /generate-image` - 图像生成接口（根据梦境描述生成AI图片）

- **技术栈**: FastAPI, Uvicorn, Python

- **注意**: 图像生成功能已直接集成在 `main.py` 中，无需单独文件

---

### 2️⃣ `analyse_script/` - 核心分析算法层

**作用**: 包含所有梦境分析的核心业务逻辑和AI模型调用

#### 📄 `analyse_script/dream_analyzer.py`
- **功能**: 梦境分析核心类
- **职责**:
  - **情绪分析**: 使用DashScope LLM（通义千问）识别梦境情绪
  - **主题提取**: 提取梦境主题（飞行、追逐、水、动物等）
  - **关键词提取**: 提取梦境关键词
  - **图像理解**: 使用BLIP模型理解用户上传的图片
  - **心理分析**: 生成详细的心理分析文本（200-400字）
  - **视觉化提示**: 生成图像生成提示词（100-200字）

- **核心类**:
  - `DashScopeLLM` - DashScope LLM封装类
  - `DreamAnalyzer` - 梦境分析器主类

- **主要方法**:
  - `analyze_dream_with_qwen()` - 使用LLM进行情绪/主题/关键词分析
  - `generate_detailed_analysis()` - 生成详细心理分析
  - `generate_visualization_prompt()` - 生成视觉化提示词
  - `generate_image_caption()` - 使用BLIP生成图像描述
  - `analyze_dream()` - 综合分析入口

- **技术栈**: Python, DashScope API, BLIP模型, PyTorch

#### 📄 `analyse_script/requirements_cpu.txt`
- **功能**: Python依赖包列表
- **用途**: 安装后端所需的Python包

#### 📄 `analyse_script/__init__.py`
- **功能**: Python包初始化文件
- **用途**: 使 `analyse_script` 成为一个可导入的Python包

---

### 3️⃣ `dream_weaver/` - 前端界面层

**作用**: 用户交互界面，发送请求到后端并展示结果

#### 📄 `dream_weaver/src/App.vue`
- **功能**: 前端主组件（核心Vue组件）
- **职责**:
  - 用户输入梦境描述
  - 图片上传功能
  - 调用后端API进行梦境分析
  - 调用后端API生成梦境图像
  - 展示分析结果（情绪、主题、关键词、心理分析、视觉化建议）
  - 展示生成的图像
  - **Three.js 3D粒子背景效果**

- **主要功能模块**:
  - 输入模块：文本输入框、图片上传
  - 分析模块：深度解析、文本分析、具象化梦境按钮
  - 展示模块：分析结果卡片、图像展示
  - 3D背景：Three.js粒子系统

- **技术栈**: Vue 3, Three.js, Vite

#### 📄 `dream_weaver/src/main.js`
- **功能**: Vue应用入口文件
- **职责**: 创建Vue应用实例并挂载到DOM

#### 📄 `dream_weaver/src/style.css`
- **功能**: 全局样式文件

#### 📄 `dream_weaver/src/history.vue`
- **功能**: 历史记录组件（如果使用）

#### 📄 `dream_weaver/src/components/HelloWorld.vue`
- **功能**: 示例组件（可删除或保留）

#### 📄 `dream_weaver/index.html`
- **功能**: HTML入口文件

#### 📄 `dream_weaver/package.json`
- **功能**: 前端依赖管理
- **主要依赖**: Vue 3, Three.js, Vite

#### 📄 `dream_weaver/vite.config.js`
- **功能**: Vite构建工具配置

---

### 4️⃣ `BLIP/` - BLIP模型库（第三方）

**作用**: BLIP图像理解模型的完整实现（第三方开源项目）

- **说明**: 
  - 这是从GitHub克隆的BLIP模型库
  - **实际使用**: 项目中使用的是HuggingFace的简化版本（`Salesforce/blip-image-captioning-base`），不是这个目录
  - **建议**: 保留作为参考，但实际运行不依赖它
  - **可以删除**: 如果不需要参考，可以删除以节省空间

---

### 5️⃣ `scripts/` - 工具和测试脚本

**作用**: 存放独立的测试脚本和工具

#### 📄 `scripts/test_image_generation.py`
- **功能**: 独立的图像生成测试脚本
- **职责**: 
  - 直接调用DashScope API生成图片
  - 测试图片生成功能
  - 不依赖Web服务，可独立运行

- **用途**: 开发测试、调试图片生成功能

#### 📄 `scripts/dream_qwen_image.png`
- **功能**: 测试生成的图片文件

---

### 6️⃣ `docs/` - 项目文档

**作用**: 存放项目文档和说明文件

---

## 🔄 数据流向图

```
┌─────────────────────────────────────────────────────────┐
│                    用户操作                              │
│  (输入梦境文本 + 可选上传图片 + 点击分析/生成图像)        │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│              dream_weaver/src/App.vue                    │
│                    (前端界面层)                          │
│  - 收集用户输入                                          │
│  - 发送HTTP请求到后端                                    │
│  - 展示分析结果                                          │
└────────────────────┬────────────────────────────────────┘
                     │ HTTP POST
                     │ /analyze 或 /generate-image
                     ▼
┌─────────────────────────────────────────────────────────┐
│                   api/main.py                            │
│                  (后端API服务层)                         │
│  - 接收HTTP请求                                          │
│  - 处理文件上传                                          │
│  - 调用核心分析模块                                      │
│  - 调用DashScope API生成图像                             │
│  - 返回JSON结果                                          │
└────────────────────┬────────────────────────────────────┘
                     │ 调用
                     ▼
┌─────────────────────────────────────────────────────────┐
│        analyse_script/dream_analyzer.py                 │
│              (核心分析算法层)                            │
│  ├─→ analyze_dream_with_qwen()                         │
│  │   └─→ DashScope LLM (通义千问)                       │
│  │       • 情绪识别                                      │
│  │       • 主题提取                                      │
│  │       • 关键词提取                                    │
│  │                                                       │
│  ├─→ generate_detailed_analysis()                       │
│  │   └─→ DashScope LLM                                  │
│  │       • 生成详细心理分析 (200-400字)                  │
│  │                                                       │
│  ├─→ generate_visualization_prompt()                    │
│  │   └─→ DashScope LLM                                  │
│  │       • 生成视觉化提示词 (100-200字)                 │
│  │                                                       │
│  └─→ generate_image_caption()                           │
│      └─→ BLIP模型 (HuggingFace)                        │
│          • 理解用户上传的图片                            │
└─────────────────────────────────────────────────────────┘
```

---

## 🎯 核心功能模块

### 功能1: 梦境分析
- **前端**: `dream_weaver/src/App.vue` - `analyze()` 函数
- **后端**: `api/main.py` - `/analyze` 接口
- **核心**: `analyse_script/dream_analyzer.py` - `analyze_dream()` 方法
- **输出**: 情绪、主题、关键词、心理分析、视觉化建议

### 功能2: 图像生成
- **前端**: `dream_weaver/src/App.vue` - `generateImage()` 函数
- **后端**: `api/main.py` - `/generate-image` 接口
- **核心**: DashScope API (qwen-image-plus)
- **输出**: Base64编码的梦境图像

### 功能3: 图像理解
- **前端**: `dream_weaver/src/App.vue` - 上传图片
- **后端**: `api/main.py` - 接收图片文件
- **核心**: `analyse_script/dream_analyzer.py` - `generate_image_caption()` 方法
- **模型**: BLIP (HuggingFace `Salesforce/blip-image-captioning-base`)
- **输出**: 图像的文字描述

---

## 🚀 启动流程

### 1. 启动后端服务
```bash
cd d:\大二上\程序设计\梦境
python api/main.py
```
- 后端运行在 `http://localhost:8000`

### 2. 启动前端服务
```bash
cd d:\大二上\程序设计\梦境\dream_weaver
npm install  # 首次运行需要
npm run dev
```
- 前端运行在 `http://localhost:5173` (Vite默认端口)

---

## 📦 依赖说明

### 后端依赖 (`analyse_script/requirements_cpu.txt`)
- `fastapi` - Web框架
- `uvicorn` - ASGI服务器
- `python-multipart` - 文件上传支持
- `dashscope` - 通义千问API
- `python-dotenv` - 环境变量管理
- `torch` - PyTorch（可选，用于BLIP）
- `transformers` - HuggingFace模型（可选，用于BLIP）
- `PIL` - 图像处理

### 前端依赖 (`dream_weaver/package.json`)
- `vue` - Vue 3框架
- `three` - Three.js 3D库
- `vite` - 构建工具

---

## 🔧 配置文件

### `.env` 文件（项目根目录）
```
DASHSCOPE_API_KEY=sk-xxxxxxxxxxxxx
```
- **必需**: 用于调用DashScope API（通义千问）

---

## 📝 实际文件清单

### 后端文件
| 文件路径 | 职责 | 技术栈 |
|---------|------|--------|
| `api/main.py` | HTTP API接口（包含图像生成） | FastAPI |
| `analyse_script/dream_analyzer.py` | 核心分析算法 | Python, LLM, BLIP |
| `analyse_script/__init__.py` | Python包初始化 | Python |

### 前端文件
| 文件路径 | 职责 | 技术栈 |
|---------|------|--------|
| `dream_weaver/src/App.vue` | 前端主组件（核心） | Vue 3, Three.js |
| `dream_weaver/src/main.js` | Vue应用入口 | Vue 3 |
| `dream_weaver/src/style.css` | 全局样式 | CSS |
| `dream_weaver/src/history.vue` | 历史记录组件 | Vue 3 |
| `dream_weaver/index.html` | HTML入口 | HTML |
| `dream_weaver/package.json` | 依赖管理 | npm |
| `dream_weaver/vite.config.js` | 构建配置 | Vite |

### 工具文件
| 文件路径 | 职责 | 技术栈 |
|---------|------|--------|
| `scripts/test_image_generation.py` | 图像生成测试脚本 | Python |

---

## ⚠️ 重要提示

1. **后端只有一个文件**: `api/main.py` 包含了所有API功能（包括图像生成）
2. **前端核心组件**: `dream_weaver/src/App.vue` 是主要的前端组件
3. **BLIP目录可以删除**: 实际使用的是HuggingFace版本，不是这个目录
4. **环境变量**: 必须在项目根目录创建 `.env` 文件，包含 `DASHSCOPE_API_KEY`
5. **端口配置**: 
   - 后端默认 8000 端口
   - 前端默认 5173 端口（Vite）
6. **依赖安装**: 
   - 后端: `pip install -r analyse_script/requirements_cpu.txt`
   - 前端: `npm install` (在 `dream_weaver` 目录下)

---

## 🎨 前端架构说明

**前端采用主组件架构**:
- `App.vue` 是核心Vue组件，包含：
  - 用户输入界面
  - API调用逻辑
  - 结果展示
  - Three.js 3D背景效果
- `history.vue` 用于历史记录功能（如果使用）
- `components/HelloWorld.vue` 是示例组件（可删除）

**优点**:
- 结构简单，易于维护
- 核心功能集中在 `App.vue`
- 适合中小型项目

**如果需要扩展**:
- 可以将功能拆分为多个组件
- 可以添加状态管理（Pinia/Vuex）
- 可以添加路由（Vue Router）

---

## 📚 相关文档

- `项目结构说明.md` - 详细的项目结构说明
- `analyse_script/使用说明.md` - 使用说明
- `analyse_script/README_课设说明.md` - 课程设计说明

